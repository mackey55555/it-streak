# IT Streak プッシュ通知設計書

## 概要

ストリーク継続を促すためのプッシュ通知メッセージ設計。
Duolingoの通知戦略を参考に、段階的な緊急度とキャラクター（すとりー🐱）を活用。

---

## 送信スケジュール

| 時間 (JST) | 通知タイプ | 目的 | 緊急度 |
|------------|-----------|------|--------|
| 7:00 | モーニング | 1日のスタートを促す | 20% |
| 12:00 | ランチタイム | 隙間時間を活用させる | 30% |
| 19:00 | イブニング | 帰宅後の学習を促す | 50% |
| 21:30 | ナイト | 緊急度を上げる | 80% |
| 23:15 | ラストチャンス | 最終警告 | 95% |
| 23:50 | デッドライン | 本当の最後 | 100% |

### 緊急度イメージ

```
7:00  ██░░░░░░░░ 20%  → ポジティブ・応援
12:00 ███░░░░░░░ 30%  → カジュアル・提案
19:00 █████░░░░░ 50%  → リマインド・軽い焦り
21:30 ████████░░ 80%  → 警告・損失強調
23:15 █████████░ 95%  → 最終警告・感情訴求
23:50 ██████████ 100% → 極限の緊急・懇願
```

---

## 送信条件

- 今日まだ学習していないユーザーのみに送信
- 23:50は23:15を送信済みの場合のみ送信（段階を踏む）

---

## 心理テクニック

| テクニック | 説明 | 使用場面 |
|-----------|------|----------|
| 損失回避 | 「失う」恐怖を刺激 | 夜〜深夜 |
| 進捗の可視化 | 達成感を強調 | 朝〜夕方 |
| キャラクター感情 | すとりーの感情で訴求 | 全時間帯 |
| 具体的数字 | ストリーク数、残り時間 | 夜〜深夜 |
| ハードル下げ | 「1問だけ」「3分だけ」 | 全時間帯 |

---

## すとりーの感情パターン

| 感情 | 使用場面 | 表現例 |
|------|----------|--------|
| 嬉しい | 朝 | 「一緒に頑張ろうね！」 |
| 期待 | 昼、夕方 | 「待ってるよ！」「今日も会えるかな？」 |
| 心配 | 夜 | 「大丈夫...？」「忘れてない...？」 |
| 悲しい | 深夜前 | 「寂しいよ...」「泣いてる...」 |
| 懇願 | 最終警告 | 「お願い...」「最後のお願い...」 |

---

## パーソナライズ変数

| 変数 | 説明 | 例 |
|------|------|-----|
| `{streak}` | 現在のストリーク日数 | 15 |
| `{remaining}` | 今日の残り問題数 | 3 |

---

## メッセージ選択ルール

1. 各時間帯で複数パターンからランダムに1つ選択
2. 過去3日間に送ったメッセージは除外（新鮮さを保つ）
3. ストリーク数に応じて優先するメッセージを変える

---

## メッセージパターン

---

### ⏰ 7:00 - モーニング

**トーン**: 明るい、前向き、1日の始まりを応援

| ID | title | body |
|----|-------|------|
| M01 | 🌅 おはよう！ | 今日も{streak}日目を積み上げよう！ |
| M02 | ☀️ 新しい1日！ | 朝の5分が合格への近道だよ |
| M03 | 🐱 すとりーより | おはよ！今日も一緒に頑張ろうね |
| M04 | 📚 朝活のチャンス | 通勤前にサクッと1問どう？ |
| M05 | 🔥 {streak}日連続！ | この調子で今日も続けよう！ |
| M06 | 💪 Good Morning! | IT資格、今日も一歩前進しよう |

**選択ロジック**:
- ストリーク5日以上 → M01, M05 を優先
- ストリーク1〜4日 → M02, M03, M04, M06 を優先

---

### ⏰ 12:00 - ランチタイム

**トーン**: カジュアル、隙間時間の活用

| ID | title | body |
|----|-------|------|
| L01 | 🍱 ランチタイム！ | 食後の3分で1問解いてみない？ |
| L02 | ☕ 休憩中？ | ちょっとだけIT Streakやろ！ |
| L03 | 🐱 すとりーだよ | お昼休み、一緒に勉強しよ？ |
| L04 | 📱 スキマ時間に | 今日の学習、まだ間に合うよ！ |
| L05 | 🎯 今日の目標 | あと{remaining}問で達成！ |

**選択ロジック**:
- デイリーゴール設定あり → L05 を優先
- それ以外 → L01〜L04 からランダム

---

### ⏰ 19:00 - イブニング

**トーン**: 友好的だが、やや急かす

| ID | title | body |
|----|-------|------|
| E01 | 🏠 おかえり！ | 今日の学習、まだだよ？ |
| E02 | 📱 忘れてない？ | {streak}日のストリーク、守ろう！ |
| E03 | 🐱 すとりーより | 今日まだ会えてないよ...？ |
| E04 | ⏰ 夜になる前に | 5問だけやっておこう！ |
| E05 | 🔥 ストリーク継続中 | あと5時間、今のうちに！ |
| E06 | 💼 お疲れさま！ | 疲れた日こそ1問だけ！ |

**選択ロジック**:
- ストリーク7日以上 → E02, E05 を優先
- ストリーク1〜6日 → E01, E03, E04, E06 を優先

---

### ⏰ 21:30 - ナイト

**トーン**: 焦りを感じさせる、でもまだ間に合う

| ID | title | body |
|----|-------|------|
| N01 | ⚠️ あと2時間半！ | {streak}日のストリークが...！ |
| N02 | 😿 すとりーが心配 | 今日の学習、忘れてない...？ |
| N03 | 🔥 ストリーク危機 | まだ間に合う！今すぐタップ！ |
| N04 | ⏰ 時間がないよ | {streak}日間の努力、無駄にしないで |
| N05 | 📉 このままだと... | ストリークがリセットされちゃう |
| N06 | 🐱 すとりーより | ねえ、今日も頑張ったって言いたいな... |

**選択ロジック**:
- ストリーク10日以上 → N01, N04, N05 を優先
- ストリーク3〜9日 → N02, N03, N06 を優先
- ストリーク1〜2日 → N03, N06 を優先

---

### ⏰ 23:15 - ラストチャンス

**トーン**: 強い緊急性、最後の訴求

| ID | title | body |
|----|-------|------|
| F01 | 🚨 あと45分！ | {streak}日のストリーク、消えちゃう！ |
| F02 | 😭 すとりーより | お願い...今日が終わっちゃう... |
| F03 | ⏰ ラストチャンス！ | 1問だけでいい、タップして！ |
| F04 | 💔 {streak}日間が... | あと少しで全部消えちゃうよ |
| F05 | 🆘 緊急！ | 今すぐ開いて！間に合う！ |
| F06 | 🐱 すとりー泣いてる | 今日も一緒に頑張りたかったのに... |

**選択ロジック**:
- ストリーク7日以上 → F01, F04 を優先
- ストリーク3〜6日 → F02, F03, F06 を優先
- ストリーク1〜2日 → F03, F05 を優先

---

### ⏰ 23:50 - デッドライン

**トーン**: 極限の緊急性、シンプルで短く、感情MAX

| ID | title | body |
|----|-------|------|
| D01 | 🚨 あと10分！！ | 今すぐ開いて！！ |
| D02 | 😭 お願い...！ | {streak}日が消えちゃう...！ |
| D03 | ⏰ 10分で終わる | 1問だけ！今すぐ！ |
| D04 | 💔 すとりーより | 最後のお願い...開いて... |
| D05 | 🆘 {streak}日間！ | 全部消える前に...！ |
| D06 | 😿 間に合って...！ | あと10分しかないよ...！ |

**選択ロジック**:
- ストリーク30日以上 → D02, D05 を優先（損失感MAX）
- ストリーク7〜29日 → D02, D04, D05 を優先
- ストリーク1〜6日 → D01, D03, D06 を優先

---

## 23:15 vs 23:50 の違い

| 項目 | 23:15（ラストチャンス） | 23:50（デッドライン） |
|------|------------------------|----------------------|
| 残り時間 | 45分 | 10分 |
| 文字数 | やや長め | 極限まで短く |
| 感嘆符 | 1つ | 2つ「！！」 |
| トーン | 「間に合う」感 | 「もう無理かも」感 |
| すとりー | 泣いてる | 懇願してる |

---

## ストリークが切れた翌日の通知（recovery）

ストリークが0にリセットされたユーザーへの励まし通知（翌日7:00）

| ID | title | body |
|----|-------|------|
| R01 | 🐱 すとりーより | また一緒に始めよう！待ってるよ |
| R02 | 🌱 新しいスタート！ | 今日から新しいストリークを作ろう |
| R03 | 💪 大丈夫！ | 何度でもやり直せる！今日から再開しよう |

---

## メッセージ一覧（実装用JSON形式）

```json
{
  "morning": [
    { "id": "M01", "title": "🌅 おはよう！", "body": "今日も{streak}日目を積み上げよう！", "streakPriority": "high" },
    { "id": "M02", "title": "☀️ 新しい1日！", "body": "朝の5分が合格への近道だよ", "streakPriority": "low" },
    { "id": "M03", "title": "🐱 すとりーより", "body": "おはよ！今日も一緒に頑張ろうね", "streakPriority": "low" },
    { "id": "M04", "title": "📚 朝活のチャンス", "body": "通勤前にサクッと1問どう？", "streakPriority": "low" },
    { "id": "M05", "title": "🔥 {streak}日連続！", "body": "この調子で今日も続けよう！", "streakPriority": "high" },
    { "id": "M06", "title": "💪 Good Morning!", "body": "IT資格、今日も一歩前進しよう", "streakPriority": "low" }
  ],
  "lunch": [
    { "id": "L01", "title": "🍱 ランチタイム！", "body": "食後の3分で1問解いてみない？" },
    { "id": "L02", "title": "☕ 休憩中？", "body": "ちょっとだけIT Streakやろ！" },
    { "id": "L03", "title": "🐱 すとりーだよ", "body": "お昼休み、一緒に勉強しよ？" },
    { "id": "L04", "title": "📱 スキマ時間に", "body": "今日の学習、まだ間に合うよ！" },
    { "id": "L05", "title": "🎯 今日の目標", "body": "あと{remaining}問で達成！", "requiresGoal": true }
  ],
  "evening": [
    { "id": "E01", "title": "🏠 おかえり！", "body": "今日の学習、まだだよ？", "streakPriority": "low" },
    { "id": "E02", "title": "📱 忘れてない？", "body": "{streak}日のストリーク、守ろう！", "streakPriority": "high" },
    { "id": "E03", "title": "🐱 すとりーより", "body": "今日まだ会えてないよ...？", "streakPriority": "low" },
    { "id": "E04", "title": "⏰ 夜になる前に", "body": "5問だけやっておこう！", "streakPriority": "low" },
    { "id": "E05", "title": "🔥 ストリーク継続中", "body": "あと5時間、今のうちに！", "streakPriority": "high" },
    { "id": "E06", "title": "💼 お疲れさま！", "body": "疲れた日こそ1問だけ！", "streakPriority": "low" }
  ],
  "night": [
    { "id": "N01", "title": "⚠️ あと2時間半！", "body": "{streak}日のストリークが...！", "streakPriority": "veryHigh" },
    { "id": "N02", "title": "😿 すとりーが心配", "body": "今日の学習、忘れてない...？", "streakPriority": "medium" },
    { "id": "N03", "title": "🔥 ストリーク危機", "body": "まだ間に合う！今すぐタップ！", "streakPriority": "low" },
    { "id": "N04", "title": "⏰ 時間がないよ", "body": "{streak}日間の努力、無駄にしないで", "streakPriority": "veryHigh" },
    { "id": "N05", "title": "📉 このままだと...", "body": "ストリークがリセットされちゃう", "streakPriority": "veryHigh" },
    { "id": "N06", "title": "🐱 すとりーより", "body": "ねえ、今日も頑張ったって言いたいな...", "streakPriority": "low" }
  ],
  "final": [
    { "id": "F01", "title": "🚨 あと45分！", "body": "{streak}日のストリーク、消えちゃう！", "streakPriority": "high" },
    { "id": "F02", "title": "😭 すとりーより", "body": "お願い...今日が終わっちゃう...", "streakPriority": "medium" },
    { "id": "F03", "title": "⏰ ラストチャンス！", "body": "1問だけでいい、タップして！", "streakPriority": "low" },
    { "id": "F04", "title": "💔 {streak}日間が...", "body": "あと少しで全部消えちゃうよ", "streakPriority": "high" },
    { "id": "F05", "title": "🆘 緊急！", "body": "今すぐ開いて！間に合う！", "streakPriority": "low" },
    { "id": "F06", "title": "🐱 すとりー泣いてる", "body": "今日も一緒に頑張りたかったのに...", "streakPriority": "medium" }
  ],
  "deadline": [
    { "id": "D01", "title": "🚨 あと10分！！", "body": "今すぐ開いて！！", "streakPriority": "low" },
    { "id": "D02", "title": "😭 お願い...！", "body": "{streak}日が消えちゃう...！", "streakPriority": "high" },
    { "id": "D03", "title": "⏰ 10分で終わる", "body": "1問だけ！今すぐ！", "streakPriority": "low" },
    { "id": "D04", "title": "💔 すとりーより", "body": "最後のお願い...開いて...", "streakPriority": "medium" },
    { "id": "D05", "title": "🆘 {streak}日間！", "body": "全部消える前に...！", "streakPriority": "high" },
    { "id": "D06", "title": "😿 間に合って...！", "body": "あと10分しかないよ...！", "streakPriority": "low" }
  ],
  "recovery": [
    { "id": "R01", "title": "🐱 すとりーより", "body": "また一緒に始めよう！待ってるよ" },
    { "id": "R02", "title": "🌱 新しいスタート！", "body": "今日から新しいストリークを作ろう" },
    { "id": "R03", "title": "💪 大丈夫！", "body": "何度でもやり直せる！今日から再開しよう" }
  ]
}
```

---

## streakPriority 選択基準

| 時間帯 | veryHigh (streak>=10) | high (streak>=5または7) | medium (streak 3-9) | low (streak 1-2または全員) |
|--------|----------------------|------------------------|---------------------|---------------------------|
| morning | - | M01, M05 | - | M02, M03, M04, M06 |
| evening | - | E02, E05 | - | E01, E03, E04, E06 |
| night | N01, N04, N05 | - | N02, N03, N06 | N03, N06 |
| final | - | F01, F04 | F02, F03, F06 | F03, F05 |
| deadline | D02, D05 (streak>=30) | D02, D04, D05 | - | D01, D03, D06 |

---

## 実装の段取り

### Phase 0: 前提・現状の確認

- [ ] 現状の Edge Function `send-daily-reminder` と GitHub Action（cron 1本）の役割を「1日1回固定時刻」から「6スロット＋recovery」に拡張する方針でよいか確認
- [ ] Expo Push API・Supabase の制限（レートリミット、Edge Function の実行時間）を確認

---

### Phase 1: データ基盤

| 順 | タスク | 内容 |
|----|--------|------|
| 1.1 | 送信ログテーブル追加 | `push_notification_log`（`user_id`, `date`, `slot`, `message_id`）を作成。過去3日間の重複排除と 23:50 の「23:15 送信済み」判定に利用 |
| 1.2 | recovery 判定用の情報 | ストリーク切れ翌日に recovery を送るため、`streaks` に「切れた日」を記録するか、または「前日時点の current_streak」を別テーブル/ログで持つか検討。案: 日次バッチで `current_streak` をスナップショットする `streak_snapshots(date, user_id, streak)` を作り、7:00 で「昨日 streak>0 かつ今日 0」のユーザーに recovery を送る |

---

### Phase 2: メッセージデータと選択ロジック

| 順 | タスク | 内容 |
|----|--------|------|
| 2.1 | メッセージ定義の配置 | 設計書の JSON を Edge Function 内の定数（`messages.ts` 相当）または Supabase の config/テーブルとして用意。変数 `{streak}`, `{remaining}` は送信時に置換 |
| 2.2 | スロット別メッセージ選択 | 入力: `slot`, `user`（streak, daily_goal）。ルール: (1) streakPriority に応じて候補を絞る (2) 過去3日分の `push_notification_log` で送信済み message_id を除外 (3) 残りからランダム1件。候補0の場合は優先度を無視して全件からランダム |
| 2.3 | 変数置換 | 選んだメッセージの title/body の `{streak}`, `{remaining}` をユーザー実値に置換。`remaining` は `daily_goal - 今日の questions_answered`（0未満は0扱い） |

---

### Phase 3: Edge Function の拡張

| 順 | タスク | 内容 |
|----|--------|------|
| 3.1 | スロット受け取り | リクエスト body で `slot`（`morning` / `lunch` / `evening` / `night` / `final` / `deadline`）を受け取る。recovery は `slot=recovery` または別エンドポイントで扱う |
| 3.2 | 対象ユーザー取得 | 従来どおり「今日まだ学習していない & notification_enabled & push_token あり」。recovery のときは「ストリーク切れ翌日」の条件を追加（Phase 1.2 の仕様に依存） |
| 3.3 | 23:50 の条件 | `slot === 'deadline'` のとき、その日の `push_notification_log` で `slot = 'final'` の送信有無をユーザーごとに確認。送信済みのユーザーにのみ deadline を送る |
| 3.4 | 1ユーザー1メッセージ選択・置換・Expo 送信 | ユーザーごとに 2.2・2.3 を実行し、Expo Push API に送信。送信後に `push_notification_log` に挿入 |
| 3.5 | バッチ分割 | 対象ユーザー数が多い場合は 100 件ずつなどに分割して Expo に送り、タイムアウトを防ぐ |

---

### Phase 4: GitHub Actions（cron）の整備

| 順 | タスク | 内容 |
|----|--------|------|
| 4.1 | JST → UTC の cron 定義 | 7:00 JST=22:00 UTC(前日), 12:00=03:00, 19:00=10:00, 21:30=12:30, 23:15=14:15, 23:50=14:50。recovery は 7:00 の同一実行内で `slot=recovery` として扱うか、別 job で呼ぶか決定 |
| 4.2 | ワークフローからスロット渡し | 各 cron ジョブで「その時刻に対応する slot」を body に含めて Edge Function を 1 回 POST（例: `{"slot":"evening"}`） |
| 4.3 | 認証 | 既存の `SUPABASE_URL` + シークレットに加え、必要なら Webhook 用シークレットで Edge Function の入口を保護 |

---

### Phase 5: recovery の仕様確定と実装

| 順 | タスク | 内容 |
|----|--------|------|
| 5.1 | 「ストリーク切れ翌日」の定義 | 新規ユーザーと区別するため、例: 前日 23:59 時点で current_streak >= 1 だったが、今日 7:00 時点で 0（昨日学習しなかった）→ recovery 対象。実装方法は 1.2 のスナップショットまたは RPC で判定 |
| 5.2 | 7:00 実行時の二重送信防止 | 通常の morning と recovery の両方に該当するユーザーは、recovery のみ送る（morning と同時送信しない）などルールを決める |

---

### Phase 6: テスト・観測

| 順 | タスク | 内容 |
|----|--------|------|
| 6.1 | 手動実行でスロットごと動作確認 | `workflow_dispatch` で slot を変えて Edge Function を叩き、対象ユーザー・メッセージ・ログが意図どおりか確認 |
| 6.2 | ログ・メトリクス | `push_notification_log` の件数集計や、Expo のレスポンスエラーをログに出し、失敗時の追いやすさを確保 |

---

### 実装順序の目安

1. **Phase 1**（ログテーブル・recovery 用の仕組み）  
2. **Phase 2**（メッセージデータ＋選択・置換ロジック。単体でテスト可能）  
3. **Phase 3**（Edge Function のスロット対応・23:50 条件・ログ書き込み）  
4. **Phase 4**（cron 6 本＋body で slot 渡し）  
5. **Phase 5**（recovery の条件と 7:00 での振り分け）  
6. **Phase 6**（手動テスト・本番監視）

Phase 2 は Edge Function 外でメッセージ選択だけを TypeScript で書いてテストしてもよい。Phase 1.2 の recovery 判定は、まず「current_streak = 0 かつ今日まだ学習していないユーザーに recovery を送る（新規は除外しない）」で始め、必要ならスナップショットを後から入れてもよい。
